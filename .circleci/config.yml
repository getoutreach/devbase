version: 2.1

orbs:
  shared: getoutreach/shared@1.32.0

jobs:
  test:
    executor:
      name: shared/testbed-docker
      go_version: 1.17.1
    steps:
      - shared/setup_environment:
          setup_remote_docker: true
      - shared/with_go_cache
      - run:
          name: Run tests
          command: make test
      - shared/save_go_cache

  release-dryrun:
    executor:
      name: shared/testbed-docker
      go_version: 1.17.1
    steps:
      - shared/setup_environment:
          setup_remote_docker: true
      - shared/with_node_cache:
          save: true
      - run:
          name: Build Orb
          command: make build-orb
      - run:
          name: Release (Dry-run)
          command: ./shell/ci/release/dryrun.sh
  release:
    executor:
      name: shared/testbed-docker
      go_version: 1.17.1
    steps:
      - shared/setup_environment:
          setup_remote_docker: true
      - shared/with_node_cache:
          save: true
      - run:
          name: Build Orb
          command: make build-orb
      - run:
          name: Release
          command: GH_TOKEN=$OUTREACH_GITHUB_TOKEN yarn --frozen-lockfile semantic-release

workflows:
  version: 2
  ###Block(circleWorkflows)
  ###EndBlock(circleWorkflows)
  build_and_test:
    jobs:
      ###Block(circleWorkflowJobs)
      ###EndBlock(circleWorkflowJobs)
      - release:
          context:
            - docker-registry
            - npm-credentials
          requires:
            - test
          filters:
            branches:
              only:
                - master
                - main
      - release-dryrun:
          context:
            - docker-registry
            - npm-credentials
          filters:
            branches:
              ignore:
                - master
                - main
      - test:
          context:
            - docker-registry
            - npm-credentials
          filters:
            # This enables running test when a tag is created.
            # This still runs on each branch.
            tags:
              only: /v\d+(\.\d+)*(-.*)*/
