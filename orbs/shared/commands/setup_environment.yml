description: Sets up CI with environment configuration
parameters:
  machine:
    type: boolean
    default: false
  setup_remote_docker:
    type: boolean
    default: false
  checkout:
    type: boolean
    default: true
  setup_devenv:
    description: Setup a fully provisioned devenv. Do not use for E2E, use setup_devenv with e2e instead.
    type: boolean
    default: false
  restore_cache:
    description: Skips restoring the cache in case a clean slate is needed.
    type: boolean
    default: true
steps:
  - when:
      condition: << parameters.setup_remote_docker >>
      steps:
        - use_docker
  - when:
      condition: << parameters.restore_cache >>
      steps:
        - restore_cache:
            keys:
              - v1-daily-cache-
        - run:
            name: Check for failed restore
            command: |
              if [[ ! -f "/home/circleci/cache-restored" ]]; then
                echo "Cache failed to restore, starting rebuild_cache"
                curl -X POST "https://circleci.com/api/v2/project/github/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pipeline ?circle-token=$CIRCLECI_API_TOKEN" \
                  --header 'content-type: application/json' \
                  -- data '{"branch":"main","parameters":{"rebuild_cache": true}}'
              fi
  # Adds a github org scoped SSH key to the project added by Wheatley
  - add_ssh_keys
  - when:
      condition: << parameters.checkout >>
      steps:
        - checkout
        - run:
            name: Checkout Submodules
            command: git submodule sync && git submodule update --init
  # When in machine mode we need to install some dependencies
  - when:
      condition: << parameters.machine >>
      steps:
        - run:
            name: Install Dependencies
            command: ./scripts/shell-wrapper.sh circleci/machine.sh
  - run:
      name: Setup CI Environment
      command: ./scripts/shell-wrapper.sh circleci/setup.sh
  - when:
      condition: << parameters.setup_devenv >>
      steps:
        - setup_devenv
