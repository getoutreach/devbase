description: Run tests on the current commit
parameters:
  app_name:
    description: Name of the application
    type: string
  docker_username:
    default: _json_key
    description: Username to use when fetching images from a registry
    type: string
  docker_password:
    default: $GCLOUD_SERVICE_ACCOUNT
    description: Environment variable to read docker password from
    type: string
  resource_class:
    description: The resource class to use for the release
    type: string
    default: "large"

resource_class: << parameters.resource_class >>

executor:
  name: testbed-docker

steps:
  - setup_environment
  - with_go_cache
  - run:
      name: Run tests
      command: make test
  - run:
      name: Upload Code Coverage
      command: ./scripts/shell-wrapper.sh ci/testing/codecov/upload-coverage.sh -f /tmp/coverage.out
  - save_go_cache # We save at the end because binaries are included with this
  - upload_test_results # Uploads to CircleCI
